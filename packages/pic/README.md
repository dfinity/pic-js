# Pic JS

Pic JS is a library for interacting with a local instance of `pocket-ic` from TypeScript.

The `pocket-ic` is a canister testing platform for the [Internet Computer](https://internetcomputer.org/). It is a standalone executable that can be used to test canisters locally, without the need to deploy them to a full replica.

Other languages available include [Python](https://github.com/dfinity/pocketic-py/) and [Rust](https://github.com/dfinity/ic/tree/master/packages/pocket-ic).

## Installation

```shell
npm i -D @hadronous/pic
```

Install peer dependencies if they are not already installed:

```shell
npm i -D @dfinity/{agent,candid,identity,principal}
```

## Usage

The easiest way to use PocketIC is to use `setupCanister` convenience method:

```ts
import { PocketIc } from '@hadronous/pic';
import { _SERVICE, idlFactory } from '../declarations';

const wasmPath = resolve('..', '..', 'canister.wasm');

const pic = await PocketIc.create();
const fixture = await pic.setupCanister<_SERVICE>(idlFactory, wasmPath);
const { actor } = fixture;

// perform tests...

await pic.tearDown();
```

If more control is needed, then the `createCanister`, `installCode` and `createActor` methods can be used directly:

```ts
import { PocketIc } from '@hadronous/pic';
import { _SERVICE, idlFactory } from '../declarations';

const wasmPath = resolve('..', '..', 'canister.wasm');

const pic = await PocketIc.create();

const canisterId = await pic.createCanister();
await pic.installCode(canisterId, wasmPath);
const actor = pic.createActor<_SERVICE>(idlFactory, canisterId);

// perform tests...

await pic.tearDown();
```

## Bun Users

PicJS leverages a [`postinstall`](https://docs.npmjs.com/cli/v9/using-npm/scripts#npm-install) script to download the `pocket-ic` binary. This is done to avoid bundling the binary with the library. If you are using [bun](https://bun.sh/) to manage your project's dependencies, then you will need to add `@hadronous/pic` as a [trusted dependency](https://bun.sh/docs/install/lifecycle#trusteddependencies) in your `package.json`:

```json
{
  "devDependencies": {
    "@hadronous/pic": "~0.2.0"
  },
  "trustedDependencies": ["@hadronous/pic"]
}
```

## API Docs

More detailed documentation is available in the [API docs](https://hadronous.github.io/pic-js/). The best place to start is with the [PocketIc](https://hadronous.github.io/pic-js/classes/PocketIc.html) class and then move on to the [Actor](https://hadronous.github.io/pic-js/interfaces/Actor.html) class.

## Examples

All examples are written in [TypeScript](https://www.typescriptlang.org/) with [Jest](https://jestjs.io/) as the test runner,
but `@hadronous/pic` can be used with JavaScript and any other testing runner, such as [NodeJS](https://nodejs.org/dist/latest-v20.x/docs/api/test.html), [bun](https://bun.sh/docs/cli/test) or [Mocha](https://mochajs.org/).

- The [Counter](https://github.com/hadronous/pic-js/tree/main/examples/counter/README.md) example demonstrates how to work with a simple canister as well as init arguments, canister upgrades and WASM reinstallation.
- The [Clock](https://github.com/hadronous/pic-js/tree/main/examples/clock/README.md) example demonstrates how to work with the replica's system time, canister timers as well as checking for canister existence and cycle management.
- The [Todo](https://github.com/hadronous/pic-js/tree/main/examples/todo/README.md) example demonstrates how to work with more complex canisters, identities, canister upgrades, and stable memory management.
- The [Multicanister](https://github.comhadronous/pic-js/tree/main/multicanister/todo/README.md) example demonstrates how to work with multiple canisters and multiple subnets.

## Canister Declarations

The DFX auto-generated bindings for canisters had some issues in versions of DFX lower than `0.16.0` that made the developer experience with PicJS less than ideal. If you are using DFX v`0.16.0` or higher then you can ignore this section.

There are four files generated by DFX for a canister. To use a `counter` canister as an example:

- `counter.did.js` - Exports the canister's Candid as a JavaScript object. The `idlFactory` and `init` exports in this file are not included in the `counter.did.d.ts` file.

  ```js
  export const idlFactory = ({ IDL }) => {
    const Counter = IDL.Service({
      // redacted...
    });
    return Counter;
  };

  export const init = ({ IDL }) => {
    return [IDL.Nat];
  };
  ```

- `counter.did.d.ts` - Exports the canister's Candid as a TypeScript interface. This file is missing the `idlFactory` and `init` exports that are present in the `counter.did.js` file.

  ```ts
  import type { Principal } from '@dfinity/principal';
  import type { ActorMethod } from '@dfinity/agent';

  export interface Counter {
    // redacted...
  }

  export interface _SERVICE extends Counter {}
  ```

- `index.d.ts` - Exports TypeScript interfaces for actor creation utilities. This file re-exports the `idlFactory`, but not the `init` declarations from `clock.did.ts`.

  ```ts
  import type {
    ActorSubclass,
    HttpAgentOptions,
    ActorConfig,
    Agent,
  } from '@dfinity/agent';
  import type { Principal } from '@dfinity/principal';
  import type { IDL } from '@dfinity/candid';

  import { _SERVICE } from './counter.did';

  export declare const idlFactory: IDL.InterfaceFactory;
  export declare const canisterId: string;

  export declare interface CreateActorOptions {
    // redacted...
  }

  export declare const createActor: (
    canisterId: string | Principal,
    options?: CreateActorOptions,
  ) => ActorSubclass<_SERVICE>;

  export declare const counter: ActorSubclass<_SERVICE>;
  ```

- `index.js` - Exports TypeScript interfaces for actor creation utilities. This file re-exports the `idlFactory`, but not the `init` declarations from `clock.did.js` and also exports an auto-created canister actor which will throw exceptions outside of the browser due to `window.location` missing.

  ```js
  import { Actor, HttpAgent } from '@dfinity/agent';

  import { idlFactory } from './counter.did.js';
  export { idlFactory } from './counter.did.js';

  export const canisterId =
    process.env.CANISTER_ID_COUNTER || process.env.COUNTER_CANISTER_ID;

  export const createActor = (canisterId, options = {}) => {
    // redacted...
  };

  export const counter = createActor(canisterId);
  ```

To summarize the problems:

- `index.js` and `index.d.ts` are missing the `init` export and also export an auto-created actor that breaks outside of the browser.
- `counter.did.js` and `counter.did.d.ts` are missing the `init` and `idlFactory` exports.

Fixes for these issues are already merged into Candid, but they need to be released and included in DFX before we can leverage them. To work around these issues for now, we can add two new files to export the missing items:

- `index.js`

  ```js
  export { idlFactory, init } from '../../declarations/counter.did';
  ```

- `index.d.ts`

  ```ts
  import { IDL } from '@dfinity/candid';
  import { Actor } from '@hadronous/pic';
  import { _SERVICE } from '../../declarations/counter.did';

  export declare const idlFactory: IDL.InterfaceFactory;
  export declare const init: ({ IDL }: { IDL: IDL }) => IDL.Type[];
  ```
